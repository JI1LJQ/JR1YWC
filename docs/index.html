<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Ulam Spiral Animation</title>
  <style>
    body { margin: 0; background: #111; }
    canvas { display: block; margin: auto; background: #000; }
  </style>
</head>
<body>
<canvas id="ulamCanvas" width="800" height="800"></canvas>

<script>
const canvas = document.getElementById("ulamCanvas");
const ctx = canvas.getContext("2d");
const width = canvas.width;
const height = canvas.height;
const centerX = width / 2;
const centerY = height / 2;

let n = 1;
let maxN = 60000;
let x = 0, y = 0;
let dx = 0, dy = -1;
let step = 1;
let rotation = 0;

function isPrime(num) {
  if (num < 2) return false;
  for (let i = 2; i <= Math.sqrt(num); i++) {
    if (num % i === 0) return false;
  }
  return true;
}

/* function draw() {
  ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
  ctx.fillRect(0, 0, width, height);

  for (let i = 0; i < 100; i++) {
    const r = step * 4;
    const angle = Math.atan2(y, x) + rotation;
    const dist = Math.sqrt(x*x + y*y);
    const px = centerX + Math.cos(angle) * dist * 4;
    const py = centerY + Math.sin(angle) * dist * 4;

    if (isPrime(n)) {
      ctx.beginPath();
      ctx.arc(px, py, 2, 0, Math.PI * 2);
      ctx.fillStyle = "lime";
      ctx.fill();
    }

    if (x === y || (x < 0 && x === -y) || (x > 0 && x === 1 - y)) {
      [dx, dy] = [-dy, dx];
    }
    x += dx;
    y += dy;
    n++;
  }

  rotation += 0.002;
  step += 0.01;
  requestAnimationFrame(draw);
} */
let primePoints = [];

function draw() {
  ctx.fillStyle = "rgba(0, 0, 0, 0.1)";
  ctx.fillRect(0, 0, width, height);

  for (let i = 0; i < 100; i++) {
    const r = step * 4;
    const angle = Math.atan2(y, x) + rotation;
    const dist = Math.sqrt(x*x + y*y);
    const px = centerX + Math.cos(angle) * dist * 4;
    const py = centerY + Math.sin(angle) * dist * 4;

    if (isPrime(n)) {
      ctx.beginPath();
      ctx.arc(px, py, 2, 0, Math.PI * 2);
      ctx.fillStyle = "lime";
      ctx.fill();

      // 素数の座標と値を保存
      primePoints.push({x: px, y: py, val: n});
    }

    if (x === y || (x < 0 && x === -y) || (x > 0 && x === 1 - y)) {
      [dx, dy] = [-dy, dx];
    }
    x += dx;
    y += dy;
    n++;
    if (n > maxN) {
      // 最大値に達したら終了
      ctx.fillStyle = "white";
      ctx.font = "20px Arial";
      ctx.fillText("Animation complete!", centerX - 100, centerY);
      return;
    }
  }

  // MOD6で差が6の倍数の素数ペアに線を描く
  const t = performance.now() / 1000; // 時間（秒）

  const r = Math.floor(128 + 127 * Math.sin(t));           // 赤：周期的に変化
  const g = Math.floor(128 + 127 * Math.sin(t + Math.PI/2)); // 緑：位相ずらし
  const b = Math.floor(128 + 127 * Math.sin(t + Math.PI));   // 青：さらに位相ずらし
  const a = 0.5 + 0.5 * Math.sin(t * 2);                    // アルファ：速く変化

  const color = `rgba(${r}, ${g}, ${b}, ${a.toFixed(2)})`;

  ctx.strokeStyle = color;
  for (let i = 0; i < primePoints.length; i++) {
    for (let j = i + 1; j < primePoints.length; j++) {
      const diff = Math.abs(primePoints[i].val - primePoints[j].val);
      if (diff % 30030 === 0 /*&& diff !== 0*/ && diff < 40000) {
        ctx.beginPath();
        ctx.moveTo(primePoints[i].x, primePoints[i].y);
        ctx.lineTo(primePoints[j].x, primePoints[j].y);
        ctx.stroke();
      }
    }
  }

  rotation += 0.003;
  step += 0.02;
  requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
